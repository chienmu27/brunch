<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>é˜¿èƒ–æ—©é»ï½œè¶…ç´šå¾Œå°</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
body { font-family: 'Noto Sans TC', sans-serif; }
.nav-btn.active { background-color: white; color: #dc2626; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
.modal-active { opacity: 1; pointer-events: auto; }
</style>
</head>
<body class="bg-gray-100 min-h-screen">

<script>
const GAS_API_URL="https://script.google.com/macros/s/AKfycbwN38uGPRGtjCQyDVUyxZvSaUCo3sXuUVSBhvZ5rk6f4a2ZsasC4opl-y14xExGhAVK/exec"; // è«‹æ›¿æ›æˆä½ çš„ GAS API ç¶²å€
</script>

<!-- ç™»å…¥è¦–çª— -->
<div id="login-view" class="fixed inset-0 bg-red-600 flex items-center justify-center z-[100] p-4">
  <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8">
    <div class="text-3xl font-black text-red-600 mb-6 text-center">é˜¿èƒ–æ—©é»ç®¡ç†ç³»çµ±</div>
    <input id="pwd" type="password" class="w-full border-2 border-gray-100 rounded-2xl px-4 py-4 mb-4 focus:outline-none focus:border-red-500 text-center text-2xl tracking-widest" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" />
    <button onclick="login()" class="w-full bg-red-600 text-white font-bold py-4 rounded-2xl text-xl hover:bg-red-700 transition-all">ç™»å…¥ç³»çµ±</button>
    <div id="login-msg" class="text-center text-red-500 mt-4 font-bold"></div>
  </div>
</div>

<!-- ç®¡ç†å¾Œå° -->
<div id="admin-view" class="hidden">
  <header class="bg-red-600 text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex flex-col md:flex-row items-center justify-between py-4 gap-4">
        <h1 class="text-2xl font-black tracking-tighter">é˜¿èƒ–æ—©é»ï½œå¾Œå°</h1>
        <nav class="flex bg-red-700 p-1 rounded-xl">
          <button onclick="switchTab('orders')" id="tab-orders" class="nav-btn active px-4 py-2 rounded-lg font-bold transition-all text-sm">è¨‚å–®ç®¡ç†</button>
          <button onclick="switchTab('history')" id="tab-history" class="nav-btn px-4 py-2 rounded-lg font-bold transition-all text-sm">è¨‚å–®ç¸½è¡¨</button>
          <button onclick="switchTab('menu')" id="tab-menu" class="nav-btn px-4 py-2 rounded-lg font-bold transition-all text-sm">èœå–®ç®¡ç†</button>
        </nav>
        <button onclick="location.reload()" class="bg-black/20 hover:bg-black/40 px-4 py-2 rounded-lg font-bold text-sm">ç™»å‡º</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6">
    <!-- å³æ™‚è¨‚å–® -->
    <section id="view-orders" class="tab-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-700"><i class="fas fa-clock mr-2"></i>å³æ™‚è¨‚å–®ç‹€æ…‹</h2>
        <button onclick="loadData()" class="text-red-600 font-bold bg-white px-4 py-2 rounded-lg shadow-sm border">æ‰‹å‹•åˆ·æ–°</button>
      </div>
      <div id="tables-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- è¨‚å–®ç¸½è¡¨ -->
    <section id="view-history" class="tab-content hidden">
      <div class="bg-white rounded-3xl shadow-sm border p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
          <h2 class="text-xl font-bold text-gray-700">æ‰€æœ‰è¨‚å–®ç´€éŒ„</h2>
          <button onclick="reqAuth('deleteAll')" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl font-bold border border-red-100 hover:bg-red-600 hover:text-white transition-all">
            <i class="fas fa-trash-alt mr-2"></i>æ¸…ç©ºæ‰€æœ‰è³‡æ–™
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="bg-gray-50 text-gray-500 text-sm uppercase">
                <th class="px-4 py-4">æ™‚é–“</th>
                <th class="px-4 py-4">æ¡Œè™Ÿ</th>
                <th class="px-4 py-4">å“é …</th>
                <th class="px-4 py-4">é‡‘é¡</th>
                <th class="px-4 py-4">ç‹€æ…‹</th>
                <th class="px-4 py-4">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="history-tbody" class="text-sm"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- èœå–®ç®¡ç† -->
    <section id="view-menu" class="tab-content hidden">
      <div class="bg-white rounded-3xl shadow-sm border p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-bold text-gray-700">èœå–®å“é …è¨­å®š</h2>
          <button onclick="openMenuModal('add')" class="bg-green-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg hover:bg-green-700 transition-all">
            <i class="fas fa-plus mr-2"></i>æ–°å¢å“é …
          </button>
        </div>
        <div class="overflow-x-auto">
          <table class="w-full text-left">
            <thead>
              <tr class="bg-gray-50 text-gray-500 text-sm">
                <th class="px-4 py-4">åˆ†é¡</th>
                <th class="px-4 py-4">åç¨±</th>
                <th class="px-4 py-4">æè¿°</th>
                <th class="px-4 py-4">åƒ¹æ ¼</th>
                <th class="px-4 py-4 text-center">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="admin-menu-tbody" class="text-sm"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- é©—è­‰ç¢¼å½ˆçª— -->
<div id="modal-auth" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[110] opacity-0 pointer-events-none transition-all">
  <div class="bg-white rounded-3xl p-8 max-w-sm w-full mx-4">
    <h3 id="auth-title" class="text-xl font-black mb-2">ç¢ºèªåŸ·è¡Œ</h3>
    <p id="auth-desc" class="text-gray-500 mb-6">æ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¼¸å…¥é©—è­‰ç¢¼</p>
    <input id="input-auth-pwd" type="password" class="w-full border-2 border-gray-100 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-red-500 text-center" placeholder="é©—è­‰ç¢¼" />
    <div class="flex gap-2">
      <button onclick="closeModal('modal-auth')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold">å–æ¶ˆ</button>
      <button id="btn-auth-confirm" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold">ç¢ºèª</button>
    </div>
  </div>
</div>

<!-- èœå–®ç·¨è¼¯å½ˆçª— -->
<div id="modal-menu-edit" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[110] opacity-0 pointer-events-none transition-all">
  <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl">
    <h3 id="menu-modal-title" class="text-xl font-black mb-6 text-red-600">ç·¨è¼¯å“é …</h3>
    <input type="hidden" id="menu-row-id" />
    <div class="space-y-4">
      <div><label class="text-xs font-bold text-gray-400">åˆ†é¡</label><input id="menu-cat" type="text" class="w-full border-b-2 py-2 focus:outline-none focus:border-red-500" /></div>
      <div><label class="text-xs font-bold text-gray-400">åç¨±</label><input id="menu-name" type="text" class="w-full border-b-2 py-2 focus:outline-none focus:border-red-500" /></div>
      <div><label class="text-xs font-bold text-gray-400">æè¿°</label><input id="menu-desc" type="text" class="w-full border-b-2 py-2 focus:outline-none focus:border-red-500" /></div>
      <div><label class="text-xs font-bold text-gray-400">å–®åƒ¹</label><input id="menu-price" type="number" class="w-full border-b-2 py-2 focus:outline-none focus:border-red-500" /></div>
    </div>
    <div class="flex gap-2 mt-8">
      <button onclick="closeModal('modal-menu-edit')" class="flex-1 bg-gray-50 py-3 rounded-xl font-bold">å–æ¶ˆ</button>
      <button onclick="triggerMenuSave()" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold">å„²å­˜</button>
    </div>
  </div>
</div>

<script>
let SESSION_TOKEN = "";
let menuData = [];
let tableButtonState = {};
let tempMenuData = {};

// é€šç”¨ API
async function api(payload){
  if(SESSION_TOKEN) payload.token = SESSION_TOKEN;
  const res = await fetch(GAS_API_URL,{method:"POST",headers:{"Content-Type":"text/plain"},body:JSON.stringify(payload)});
  return await res.json();
}

// ç™»å…¥
async function login(){
  const pwd = document.getElementById('pwd').value.trim();
  const res = await api({action:"adminLogin",password:pwd});
  if(res.ok){
    SESSION_TOKEN = pwd;
    document.getElementById('login-view').classList.add('hidden');
    document.getElementById('admin-view').classList.remove('hidden');
    loadData();
  } else {
    document.getElementById('login-msg').innerText="å¯†ç¢¼éŒ¯èª¤";
  }
}

// åˆ†é åˆ‡æ›
function switchTab(tabId){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.add('hidden'));
  document.getElementById('view-'+tabId).classList.remove('hidden');
  document.querySelectorAll('.nav-btn').forEach(btn=>btn.classList.remove('active'));
  document.getElementById('tab-'+tabId).classList.add('active');
  if(tabId==='history') loadHistory();
  else if(tabId==='menu') loadAdminMenu();
  else if(tabId==='orders') loadData();
}

// å³æ™‚è¨‚å–®
async function loadData(){
  const res = await api({action:"getPendingOrdersMerged"});
  const root = document.getElementById('tables-grid');
  root.innerHTML="";
  if(!res.data || res.data.length===0){
    root.innerHTML='<div class="col-span-full text-center py-20 text-gray-400">å°šç„¡æº–å‚™ä¸­çš„è¨‚å–®</div>';
    return;
  }
  res.data.forEach(t=>{
    if(!tableButtonState[t.table]) tableButtonState[t.table]=(t.status==='served')?'completed':'served';
    const isWait = tableButtonState[t.table]==='completed';
    root.innerHTML+=`
    <div class="bg-white rounded-3xl p-6 shadow-sm border-2 ${isWait?'border-blue-400 bg-blue-50':'border-white'}">
      <div class="flex justify-between items-start mb-4">
        <h3 class="text-2xl font-black">æ¡Œè™Ÿ ${t.table}</h3>
        <button onclick="handleTableStatus('${t.table}')" class="px-6 py-2 rounded-xl font-bold text-white ${isWait?'bg-blue-600':'bg-green-600'}">
          ${isWait?'ğŸ’° çµå¸³':'ğŸšš é€é¤'}
        </button>
      </div>
      <div class="space-y-2 border-y py-4 my-4">
        ${t.items.map(i=>`<div class="flex justify-between text-sm"><span>${i.item} x ${i.qty}</span><span class="font-bold">$${i.subtotal}</span></div>`).join('')}
      </div>
      <div class="text-right text-xl font-black text-red-600">$${t.total}</div>
    </div>`;
  });
}

async function handleTableStatus(tableNo){
  const next = tableButtonState[tableNo];
  if(next==='completed' && !confirm('ç¢ºå®šçµå¸³ï¼Ÿ')) return;
  const res = await api({action:"markTableStatus",table:tableNo,status:next});
  if(res.ok){
    if(next==='completed') delete tableButtonState[tableNo];
    else tableButtonState[tableNo]='completed';
    loadData();
  }
}

// è¨‚å–®ç¸½è¡¨
async function loadHistory(){
  const tbody=document.getElementById('history-tbody');
  tbody.innerHTML='<tr><td colspan="6" class="p-10 text-center">è®€å–ä¸­...</td></tr>';
  const res = await api({action:"getOrderHistory"});
  if(res.ok){
    const total=res.data.length;
    tbody.innerHTML=res.data.map((r,i)=>{
      let statusText='',statusClass='';
      if(r.status==='completed'){statusText='å·²çµå–®';statusClass='text-gray-400';}
      else if(r.status==='served'){statusText='å·²é€é¤';statusClass='text-blue-600 font-bold';}
      else{statusText='æº–å‚™ä¸­';statusClass='text-green-600 font-bold';}
      return `<tr class="border-b hover:bg-gray-50">
        <td class="px-4 py-4 text-xs">${new Date(r.time).toLocaleString()}</td>
        <td class="px-4 py-4 font-bold">${r.table}</td>
        <td class="px-4 py-4">${r.name} x ${r.qty}</td>
        <td class="px-4 py-4 font-bold text-red-600">$${r.subtotal}</td>
        <td class="px-4 py-4"><span class="${statusClass}">${statusText}</span></td>
        <td class="px-4 py-4">
          <button onclick="reqAuth('deleteOrder',${total-i+1})" class="text-gray-300 hover:text-red-600"><i class="fas fa-trash-alt"></i></button>
        </td>
      </tr>`;
    }).join('');
  }
}

// èœå–®ç®¡ç†
async function loadAdminMenu(){
  const tbody=document.getElementById('admin-menu-tbody');
  tbody.innerHTML='<tr><td colspan="5" class="p-10 text-center">èœå–®è¼‰å…¥ä¸­...</td></tr>';
  try{
    const res = await fetch(`${GAS_API_URL}?action=getMenu`).then(r=>r.json());
    if(res.ok){
      menuData=res.data;
      tbody.innerHTML=res.data.map(m=>`
        <tr class="border-b hover:bg-gray-50">
          <td class="px-4 py-4 font-bold text-red-600">${m.category}</td>
          <td class="px-4 py-4 font-black">${m.name}</td>
          <td class="px-4 py-4 text-gray-400 text-xs">${m.desc}</td>
          <td class="px-4 py-4 font-bold">$${m.price}</td>
          <td class="px-4 py-4 text-center space-x-2">
            <button onclick="openMenuModal('edit',${m.row})" class="text-blue-500"><i class="fas fa-edit"></i></button>
            <button onclick="reqAuth('deleteMenu',${m.row})" class="text-gray-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`).join('');
    } else tbody.innerHTML='<tr><td colspan="5" class="p-10 text-center text-red-500">ç„¡æ³•è§£æèœå–®æ•¸æ“š</td></tr>';
  } catch(e){ tbody.innerHTML='<tr><td colspan="5" class="p-10 text-center text-red-500">èœå–®è¼‰å…¥å¤±æ•—ï¼š'+e.message+'</td></tr>'; }
}

// å½ˆçª—é‚è¼¯
function openMenuModal(mode,rowId){
  const modal=document.getElementById('modal-menu-edit');
  modal.classList.add('modal-active');
  if(mode==='add'){
    document.getElementById('menu-row-id').value="";
    ['cat','name','desc','price'].forEach(k=>document.getElementById('menu-'+k).value="");
  } else {
    const item=menuData.find(m=>m.row===rowId);
    document.getElementById('menu-row-id').value=rowId;
    document.getElementById('menu-cat').value=item.category;
    document.getElementById('menu-name').value=item.name;
    document.getElementById('menu-desc').value=item.desc;
    document.getElementById('menu-price').value=item.price;
  }
}

function closeModal(id){document.getElementById(id).classList.remove('modal-active');}

function triggerMenuSave(){
  tempMenuData={
    row:document.getElementById('menu-row-id').value,
    category:document.getElementById('menu-cat').value,
    name:document.getElementById('menu-name').value,
    desc:document.getElementById('menu-desc').value,
    price:document.getElementById('menu-price').value
  };
  reqAuth(tempMenuData.row?'editMenu':'addMenu');
}

// é©—è­‰ç¢¼ç¢ºèª
function reqAuth(type,row){
  const modal=document.getElementById('modal-auth');
  modal.classList.add('modal-active');
  document.getElementById('input-auth-pwd').value="";
  document.getElementById('btn-auth-confirm').onclick=async()=>{
    const pwd=document.getElementById('input-auth-pwd').value;
    let payload={action:"",password:pwd};
    if(type==='deleteAll') payload.action="deleteAllOrders";
    else if(type==='deleteMenu'){payload.action="deleteMenuItem";payload.row=row;}
    else if(type==='deleteOrder'){payload.action="deleteMenuItem";payload.row=row;payload.targetSheet="order";}
    else if(type==='addMenu'){payload={...payload,...tempMenuData,action:"addMenuItem"};}
    else if(type==='editMenu'){payload={...payload,...tempMenuData,action:"editMenuItem"};}
    const res = await api(payload);
    if(res.ok){
      alert('åŸ·è¡ŒæˆåŠŸ');
      closeModal('modal-auth'); closeModal('modal-menu-edit');
      if(type.includes('Menu')) loadAdminMenu(); else loadHistory();
    } else alert(res.message);
  };
}

// æ”¯æ´ ENTER
document.addEventListener('keypress',e=>{
  if(e.key==='Enter'){
    const activeEl=document.activeElement;
    if(activeEl.id==='pwd') login();
    if(document.getElementById('modal-auth').classList.contains('modal-active')) document.getElementById('btn-auth-confirm').click();
    if(document.getElementById('modal-menu-edit').classList.contains('modal-active')) triggerMenuSave();
  }
});
</script>
</body>
</html>
