<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é˜¿èƒ–æ—©é»ï½œè¶…ç´šå¾Œå°</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; }
    .nav-btn.active { background-color: white; color: #dc2626; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
    .modal-active { opacity: 1; pointer-events: auto; }
    /* è½‰åœˆåœˆå‹•ç•« */
    .fa-spin-fast { animation: fa-spin 1s infinite linear; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">

<script>
  // â˜…â˜…â˜… è«‹å‹™å¿…ç¢ºèªæ­¤è™• GAS ç¶²å€å·²éƒ¨ç½²ç‚ºæœ€æ–°ç‰ˆæœ¬ â˜…â˜…â˜…
  const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwN38uGPRGtjCQyDVUyxZvSaUCo3sXuUVSBhvZ5rk6f4a2ZsasC4opl-y14xExGhAVK/exec";
</script>

<!-- ç™»å…¥ç•«é¢ -->
<div id="login-view" class="fixed inset-0 bg-red-600 flex items-center justify-center z-[100] p-4">
  <div class="bg-white w-full max-w-md rounded-3xl shadow-2xl p-8">
    <div class="text-3xl font-black text-red-600 mb-6 text-center">é˜¿èƒ–æ—©é»ç®¡ç†ç³»çµ±</div>
    <input id="pwd" type="password" class="w-full border-2 border-gray-100 rounded-2xl px-4 py-4 mb-4 focus:outline-none focus:border-red-500 text-center text-2xl tracking-widest" placeholder="è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼" onkeypress="if(event.key==='Enter') login()" />
    <button onclick="login()" class="w-full bg-red-600 text-white font-bold py-4 rounded-2xl text-xl hover:bg-red-700 transition-all">ç™»å…¥ç³»çµ±</button>
    <div id="login-msg" class="text-center text-red-500 mt-4 font-bold"></div>
  </div>
</div>

<!-- ä¸»ç®¡ç†ä»‹é¢ -->
<div id="admin-view" class="hidden">
  <header class="bg-red-600 text-white shadow-lg sticky top-0 z-50">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex flex-col md:flex-row items-center justify-between py-4 gap-4">
        <h1 class="text-2xl font-black tracking-tighter">é˜¿èƒ–æ—©é»ï½œå¾Œå°</h1>
        <nav class="flex bg-red-700 p-1 rounded-xl">
          <button onclick="switchTab('orders')" id="tab-orders" class="nav-btn active px-4 py-2 rounded-lg font-bold transition-all text-sm">è¨‚å–®ç®¡ç†</button>
          <button onclick="switchTab('history')" id="tab-history" class="nav-btn px-4 py-2 rounded-lg font-bold transition-all text-sm">è¨‚å–®ç¸½è¡¨</button>
          <button onclick="switchTab('menu')" id="tab-menu" class="nav-btn px-4 py-2 rounded-lg font-bold transition-all text-sm">èœå–®ç®¡ç†</button>
        </nav>
        <button onclick="location.reload()" class="bg-black/20 hover:bg-black/40 px-4 py-2 rounded-lg font-bold text-sm">ç™»å‡º</button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto p-4 md:p-6">
    
    <!-- åˆ†é  1: å³æ™‚è¨‚å–® (å»šæˆ¿ç”¨) -->
    <section id="view-orders" class="tab-content">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-700"><i class="fas fa-fire mr-2 text-red-500"></i>å»šæˆ¿æ¥å–®</h2>
        <button onclick="loadData()" class="text-blue-600 font-bold bg-white px-4 py-2 rounded-lg shadow-sm border hover:bg-blue-50 transition-colors">
          <i class="fas fa-sync-alt mr-1"></i>æ‰‹å‹•åˆ·æ–°
        </button>
      </div>
      <div id="tables-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
    </section>

    <!-- åˆ†é  2: è¨‚å–®ç¸½è¡¨ (æ­·å²èˆ‡åˆªé™¤) -->
    <section id="view-history" class="tab-content hidden">
      <div class="bg-white rounded-3xl shadow-sm border p-6">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
          <div class="flex items-center gap-4">
            <h2 class="text-xl font-bold text-gray-700">è¨‚å–®ç¸½è¡¨</h2>
            <button onclick="loadHistory()" class="text-blue-600 font-bold bg-gray-100 px-3 py-1 rounded-lg text-sm hover:bg-blue-100 transition-colors">
              <i class="fas fa-sync-alt mr-1"></i>æ‰‹å‹•åˆ·æ–°
            </button>
          </div>
          
          <button onclick="reqAuth('deleteAll')" class="bg-red-50 text-red-600 px-4 py-2 rounded-xl font-bold border border-red-100 hover:bg-red-600 hover:text-white transition-all">
            <i class="fas fa-bomb mr-2"></i>æ¸…ç©ºæ‰€æœ‰è³‡æ–™
          </button>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="bg-gray-100 text-gray-600 text-sm uppercase tracking-wider">
                <th class="px-4 py-3 rounded-tl-xl">æ™‚é–“</th>
                <th class="px-4 py-3">æ¡Œè™Ÿ</th>
                <th class="px-4 py-3">å“é …</th>
                <th class="px-4 py-3">é‡‘é¡</th>
                <th class="px-4 py-3">ç‹€æ…‹</th>
                <th class="px-4 py-3 rounded-tr-xl">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="history-tbody" class="text-sm divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- åˆ†é  3: èœå–®ç®¡ç† -->
    <section id="view-menu" class="tab-content hidden">
      <div class="bg-white rounded-3xl shadow-sm border p-6">
        <div class="flex justify-between items-center mb-6">
          <div class="flex items-center gap-4">
            <h2 class="text-xl font-bold text-gray-700">èœå–®å“é …è¨­å®š</h2>
            <button onclick="loadAdminMenu()" class="text-blue-600 font-bold bg-gray-100 px-3 py-1 rounded-lg text-sm hover:bg-blue-100 transition-colors">
              <i class="fas fa-sync-alt mr-1"></i>æ‰‹å‹•åˆ·æ–°
            </button>
          </div>
          
          <button onclick="openMenuModal('add')" class="bg-green-600 text-white px-6 py-2 rounded-xl font-bold shadow-lg hover:bg-green-700 transition-all flex items-center">
            <i class="fas fa-plus mr-2"></i>æ–°å¢å“é …
          </button>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full text-left border-collapse">
            <thead>
              <tr class="bg-gray-100 text-gray-600 text-sm tracking-wider">
                <th class="px-4 py-3 rounded-tl-xl">åˆ†é¡</th>
                <th class="px-4 py-3">åç¨±</th>
                <th class="px-4 py-3">æè¿°</th>
                <th class="px-4 py-3">åƒ¹æ ¼</th>
                <th class="px-4 py-3 text-center rounded-tr-xl">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="admin-menu-tbody" class="text-sm divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</div>

<!-- é©—è­‰å½ˆçª— -->
<div id="modal-auth" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[110] opacity-0 pointer-events-none transition-all duration-300">
  <div class="bg-white rounded-3xl p-8 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300" id="modal-auth-content">
    <h3 class="text-xl font-black mb-2 text-gray-800">ğŸ”’ å®‰å…¨é©—è­‰</h3>
    <p id="auth-desc" class="text-gray-500 mb-6">åŸ·è¡Œæ­¤åˆªé™¤æˆ–ä¿®æ”¹æ“ä½œéœ€è¦ç®¡ç†å¯†ç¢¼ã€‚</p>
    <input id="input-auth-pwd" type="password" class="w-full border-2 border-gray-100 rounded-xl px-4 py-3 mb-4 focus:outline-none focus:border-red-500 text-center tracking-widest text-lg" placeholder="è«‹è¼¸å…¥å¯†ç¢¼" />
    <div class="flex gap-3">
      <button onclick="closeModal('modal-auth')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-600 hover:bg-gray-200">å–æ¶ˆ</button>
      <button id="btn-auth-confirm" class="flex-1 bg-red-600 text-white py-3 rounded-xl font-bold hover:bg-red-700 shadow-lg">ç¢ºèªåŸ·è¡Œ</button>
    </div>
  </div>
</div>

<!-- èœå–®ç·¨è¼¯/æ–°å¢å½ˆçª— -->
<div id="modal-menu-edit" class="fixed inset-0 bg-black/60 flex items-center justify-center z-[110] opacity-0 pointer-events-none transition-all duration-300">
  <div class="bg-white rounded-3xl p-8 max-w-md w-full mx-4 shadow-2xl transform scale-95 transition-transform duration-300" id="modal-menu-content">
    <h3 id="menu-modal-title" class="text-xl font-black mb-6 text-gray-800 border-l-4 border-red-500 pl-3">ç·¨è¼¯å“é …</h3>
    <input type="hidden" id="menu-row-id" />
    <div class="space-y-4">
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">åˆ†é¡ (Category)</label>
        <input id="menu-cat" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-red-500 transition-colors" placeholder="ä¾‹å¦‚ï¼šè›‹é¤…é¡" />
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">é¤é»åç¨± (Name)</label>
        <input id="menu-name" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-red-500 transition-colors" placeholder="ä¾‹å¦‚ï¼šèµ·å¸è›‹é¤…" />
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">æè¿° (Description)</label>
        <input id="menu-desc" type="text" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-red-500 transition-colors" placeholder="å£æ„Ÿæ•˜è¿°" />
      </div>
      <div>
        <label class="block text-xs font-bold text-gray-500 mb-1">åƒ¹æ ¼ (Price)</label>
        <input id="menu-price" type="number" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 focus:outline-none focus:border-red-500 transition-colors" placeholder="50" />
      </div>
    </div>
    <div class="flex gap-3 mt-8">
      <button onclick="closeModal('modal-menu-edit')" class="flex-1 bg-gray-100 py-3 rounded-xl font-bold text-gray-600 hover:bg-gray-200">å–æ¶ˆ</button>
      <button onclick="triggerMenuSave()" class="flex-1 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 shadow-lg">å„²å­˜è®Šæ›´</button>
    </div>
  </div>
</div>

<script>
  let SESSION_TOKEN = "";
  let menuData = [];
  let tableButtonState = {};
  let tempMenuData = {};

  // === é€šç”¨ API è«‹æ±‚ ===
  async function api(payload){
    if(SESSION_TOKEN) payload.token = SESSION_TOKEN;
    
    // é¡¯ç¤º Loading (é¸ç”¨ï¼Œé¿å…ç•«é¢å‡çµæ„Ÿ)
    document.body.style.cursor = 'wait';
    
    try {
      const res = await fetch(GAS_API_URL, {
        method: "POST",
        headers: { "Content-Type": "text/plain;charset=utf-8" },
        body: JSON.stringify(payload)
      });
      document.body.style.cursor = 'default';
      return await res.json();
    } catch(e) {
      document.body.style.cursor = 'default';
      alert("é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
      return { ok: false };
    }
  }

  // === ç™»å…¥ç³»çµ± ===
  async function login(){
    const pwd = document.getElementById("pwd").value.trim();
    if(!pwd) return;
    const btn = document.querySelector('#login-view button');
    btn.innerText = "é©—è­‰ä¸­...";
    
    const data = await api({ action:"adminLogin", password: pwd });
    
    if(data && data.ok){
      SESSION_TOKEN = pwd;
      document.getElementById("login-view").classList.add("hidden");
      document.getElementById("admin-view").classList.remove("hidden");
      // é è¨­è¼‰å…¥è¨‚å–®
      loadData();
    } else {
      document.getElementById("login-msg").innerText = "å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦";
      btn.innerText = "ç™»å…¥ç³»çµ±";
    }
  }

  // === åˆ†é åˆ‡æ› ===
  function switchTab(tabId) {
    // éš±è—æ‰€æœ‰åˆ†é å…§å®¹
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    // é¡¯ç¤ºç›®æ¨™åˆ†é 
    document.getElementById('view-' + tabId).classList.remove('hidden');
    
    // æ›´æ–°æŒ‰éˆ•æ¨£å¼
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById('tab-' + tabId).classList.add('active');
    
    // æ ¹æ“šåˆ†é è¼‰å…¥æ•¸æ“š
    if(tabId === 'history') loadHistory();
    else if(tabId === 'menu') loadAdminMenu();
    else if(tabId === 'orders') loadData();
  }

  // ==============================
  // 1. å»šæˆ¿æ¥å–® (è¨‚å–®ç®¡ç†)
  // ==============================
  async function loadData(){
    const res = await api({ action: "getPendingOrdersMerged" });
    const root = document.getElementById("tables-grid");
    root.innerHTML = "";
    
    if(!res.data || res.data.length === 0) {
      root.innerHTML = '<div class="col-span-full text-center py-20 text-gray-400"><i class="fas fa-mug-hot text-4xl mb-4"></i><p>ç›®å‰æ²’æœ‰å¾…è™•ç†è¨‚å–®</p></div>';
      return;
    }
    
    res.data.forEach(t => {
      // åˆ¤æ–·æŒ‰éˆ•ç‹€æ…‹é‚è¼¯
      if (!tableButtonState[t.table]) {
        tableButtonState[t.table] = (t.status === "served") ? "completed" : "served";
      }
      const nextAction = tableButtonState[t.table]; // 'served' (å»é€é¤) or 'completed' (å»çµå¸³)
      const isWaitPay = nextAction === "completed"; // true è¡¨ç¤ºå·²é€é¤ï¼Œç­‰å¾…çµå¸³
      
      root.innerHTML += `
        <div class="bg-white rounded-3xl p-6 shadow-sm border-2 ${isWaitPay ? 'border-blue-400 bg-blue-50' : 'border-white'} transition-all hover:shadow-md">
          <div class="flex justify-between items-start mb-4">
            <h3 class="text-2xl font-black text-gray-800">æ¡Œè™Ÿ ${t.table}</h3>
            <button onclick="handleTableStatus('${t.table}')" class="px-6 py-2 rounded-xl font-bold text-white shadow-md transform active:scale-95 transition-all ${isWaitPay ? 'bg-blue-600 hover:bg-blue-700' : 'bg-green-600 hover:bg-green-700'}">
              ${isWaitPay ? 'ğŸ’° çµå¸³' : 'ğŸšš é€é¤'}
            </button>
          </div>
          <div class="space-y-2 border-t border-b border-dashed border-gray-300 py-4 my-4">
            ${t.items.map(i => `
              <div class="flex justify-between text-sm items-center">
                <span class="text-gray-700 font-medium">${i.item} <span class="text-xs text-gray-400">x ${i.qty}</span></span>
                <span class="font-bold text-gray-900">$${i.subtotal}</span>
              </div>
            `).join('')}
          </div>
          <div class="flex justify-between items-center">
             <span class="text-xs font-bold px-2 py-1 rounded ${isWaitPay ? 'bg-blue-200 text-blue-800' : 'bg-green-100 text-green-800'}">
               ${isWaitPay ? 'å·²å‡ºé¤' : 'æº–å‚™ä¸­'}
             </span>
             <div class="text-right text-2xl font-black text-red-600">$${t.total}</div>
          </div>
        </div>`;
    });
  }

  async function handleTableStatus(tableNo){
    const next = tableButtonState[tableNo];
    // å¦‚æœæ˜¯çµå¸³ï¼Œå¤šä¸€å€‹ç¢ºèª
    if(next === 'completed' && !confirm('ç¢ºå®šè©²æ¡Œå·²ä»˜æ¬¾ä¸¦çµå¸³ï¼Ÿæ­¤æ“ä½œå°‡å°å­˜è¨‚å–®ã€‚')) return;
    
    const res = await api({ action: "markTableStatus", table: tableNo, status: next });
    if(res.ok) {
      if(next === 'completed') delete tableButtonState[tableNo]; // é‡ç½®
      else tableButtonState[tableNo] = 'completed'; // ä¸‹ä¸€æ­¥è®Šçµå¸³
      loadData();
    }
  }

  // ==============================
  // 2. è¨‚å–®ç¸½è¡¨ (æ­·å²ç´€éŒ„)
  // ==============================
  async function loadHistory() {
    const tbody = document.getElementById('history-tbody');
    tbody.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>è®€å–ä¸­...</td></tr>';
    
    const res = await api({ action: "getOrderHistory" });
    
    if(res.ok && res.data.length > 0) {
      tbody.innerHTML = res.data.map((r) => {
        let statusBadge = "";
        if (r.status === 'completed') statusBadge = '<span class="px-2 py-1 rounded bg-gray-100 text-gray-500 text-xs font-bold">å·²çµå–®</span>';
        else if (r.status === 'served') statusBadge = '<span class="px-2 py-1 rounded bg-blue-100 text-blue-600 text-xs font-bold">å·²é€é¤</span>';
        else statusBadge = '<span class="px-2 py-1 rounded bg-green-100 text-green-600 text-xs font-bold">æº–å‚™ä¸­</span>';

        // æ³¨æ„ï¼šé€™è£¡å‚³å…¥ r.row çµ¦åˆªé™¤å‡½å¼
        return `
        <tr class="hover:bg-gray-50 transition-colors group">
          <td class="px-4 py-4 text-xs text-gray-500">${new Date(r.time).toLocaleString()}</td>
          <td class="px-4 py-4 font-bold text-gray-800">${r.table}</td>
          <td class="px-4 py-4 text-gray-700">${r.name} <span class="text-xs text-gray-400">x ${r.qty}</span></td>
          <td class="px-4 py-4 font-bold text-red-600">$${r.subtotal}</td>
          <td class="px-4 py-4">${statusBadge}</td>
          <td class="px-4 py-4">
            <button onclick="reqAuth('deleteOrder', ${r.row})" class="bg-white border border-gray-200 text-gray-400 hover:text-red-600 hover:border-red-200 px-3 py-1 rounded-lg shadow-sm transition-all text-xs font-bold">
              åˆªé™¤
            </button>
          </td>
        </tr>`;
      }).join('');
    } else {
      tbody.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-gray-400">ç›®å‰æ²’æœ‰ä»»ä½•è¨‚å–®ç´€éŒ„</td></tr>';
    }
  }

  // ==============================
  // 3. èœå–®ç®¡ç†
  // ==============================
  async function loadAdminMenu() {
    const tbody = document.getElementById('admin-menu-tbody');
    tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-500"><i class="fas fa-spinner fa-spin mr-2"></i>èœå–®è¼‰å…¥ä¸­...</td></tr>';
    
    try {
      const resp = await fetch(`${GAS_API_URL}?action=getMenu`);
      const res = await resp.json();
      if(res.ok && res.data.length > 0) {
        menuData = res.data;
        tbody.innerHTML = res.data.map(m => `
          <tr class="hover:bg-gray-50 transition-colors border-b last:border-0">
            <td class="px-4 py-4 font-bold text-red-600 text-sm">${m.category}</td>
            <td class="px-4 py-4 font-black text-gray-800">${m.name}</td>
            <td class="px-4 py-4 text-gray-400 text-xs max-w-xs truncate">${m.desc}</td>
            <td class="px-4 py-4 font-bold text-gray-700">$${m.price}</td>
            <td class="px-4 py-4 text-center">
              <div class="flex items-center justify-center gap-2">
                <button onclick="openMenuModal('edit', ${m.row})" class="bg-blue-50 text-blue-600 p-2 rounded-lg hover:bg-blue-600 hover:text-white transition-all" title="ç·¨è¼¯">
                  <i class="fas fa-edit"></i>
                </button>
                <button onclick="reqAuth('deleteMenu', ${m.row})" class="bg-red-50 text-red-600 p-2 rounded-lg hover:bg-red-600 hover:text-white transition-all" title="åˆªé™¤">
                  <i class="fas fa-trash-alt"></i>
                </button>
              </div>
            </td>
          </tr>`).join('');
      } else {
        tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-gray-400">èœå–®æ˜¯ç©ºçš„ï¼Œè«‹æ–°å¢å“é …</td></tr>';
      }
    } catch (e) {
      tbody.innerHTML = '<tr><td colspan="5" class="p-10 text-center text-red-500">è¼‰å…¥å¤±æ•—</td></tr>';
    }
  }

  // ==============================
  // å½ˆçª—èˆ‡é©—è­‰é‚è¼¯
  // ==============================
  
  // é–‹å•Ÿèœå–®ç·¨è¼¯/æ–°å¢è¦–çª—
  function openMenuModal(mode, rowId) {
    const modal = document.getElementById('modal-menu-edit');
    const content = document.getElementById('modal-menu-content');
    modal.classList.add('modal-active');
    // ç°¡å–®çš„å½ˆå‡ºå‹•ç•«é‡ç½®
    content.classList.remove('scale-95');
    content.classList.add('scale-100');

    if(mode === 'add') {
      document.getElementById('menu-modal-title').innerText = "æ–°å¢å“é …";
      document.getElementById('menu-row-id').value = "";
      ['cat','name','desc','price'].forEach(k => document.getElementById('menu-'+k).value = "");
    } else {
      document.getElementById('menu-modal-title').innerText = "ç·¨è¼¯å“é …";
      const item = menuData.find(m => m.row === rowId);
      if(item){
        document.getElementById('menu-row-id').value = rowId;
        document.getElementById('menu-cat').value = item.category;
        document.getElementById('menu-name').value = item.name;
        document.getElementById('menu-desc').value = item.desc;
        document.getElementById('menu-price').value = item.price;
      }
    }
  }

  // é—œé–‰ä»»ä½•å½ˆçª—
  function closeModal(id) { 
    const modal = document.getElementById(id);
    const content = modal.querySelector('div'); // å…§å®¹å®¹å™¨
    content.classList.remove('scale-100');
    content.classList.add('scale-95');
    setTimeout(() => {
        modal.classList.remove('modal-active');
    }, 150);
  }

  // æŒ‰ä¸‹èœå–®å„²å­˜æŒ‰éˆ• -> è§¸ç™¼é©—è­‰
  function triggerMenuSave() {
    tempMenuData = {
      row: document.getElementById('menu-row-id').value,
      category: document.getElementById('menu-cat').value,
      name: document.getElementById('menu-name').value,
      desc: document.getElementById('menu-desc').value,
      price: document.getElementById('menu-price').value
    };
    
    // å¦‚æœæ˜¯æ–°å¢ï¼Œå°±å‘¼å« addMenuï¼Œå¦å‰‡ editMenu
    reqAuth(tempMenuData.row ? 'editMenu' : 'addMenu');
  }

  // è«‹æ±‚æ¬Šé™é©—è­‰ (æ‰€æœ‰æ•æ„Ÿæ“ä½œéƒ½é€šéé€™è£¡)
  function reqAuth(type, row) {
    const modal = document.getElementById('modal-auth');
    const content = document.getElementById('modal-auth-content');
    modal.classList.add('modal-active');
    content.classList.remove('scale-95');
    content.classList.add('scale-100');

    const inputPwd = document.getElementById('input-auth-pwd');
    inputPwd.value = ""; // æ¸…ç©º
    inputPwd.focus();

    // ç¶å®šç¢ºèªæŒ‰éˆ•äº‹ä»¶
    document.getElementById('btn-auth-confirm').onclick = async () => {
      const pwd = inputPwd.value;
      if(!pwd) return alert("è«‹è¼¸å…¥å¯†ç¢¼");

      let payload = { action: "", password: pwd };

      // æ ¹æ“šæ“ä½œé¡å‹çµ„è£ payload
      if (type === 'deleteAll') {
        if(!confirm("è­¦å‘Šï¼é€™å°‡æ¸…é™¤æ‰€æœ‰æ­·å²è¨‚å–®è³‡æ–™ï¼")) return;
        payload.action = "deleteAllOrders";
      }
      else if (type === 'deleteOrder') {
        payload.action = "deleteOrder";
        payload.row = row;
      }
      else if (type === 'deleteMenu') {
        payload.action = "deleteMenuItem";
        payload.row = row;
      }
      else if (type === 'addMenu') {
        payload = { ...payload, ...tempMenuData, action: "addMenuItem" };
      }
      else if (type === 'editMenu') {
        payload = { ...payload, ...tempMenuData, action: "editMenuItem" };
      }
      
      // ç™¼é€è«‹æ±‚
      const btn = document.getElementById('btn-auth-confirm');
      const orgText = btn.innerText;
      btn.innerText = "è™•ç†ä¸­...";
      
      const res = await api(payload);
      btn.innerText = orgText;

      if(res.ok) {
        // alert('åŸ·è¡ŒæˆåŠŸ'); 
        // æˆåŠŸå¾Œé—œé–‰è¦–çª—ä¸¦åˆ·æ–°å°æ‡‰é é¢
        closeModal('modal-auth');
        if(type.includes('Menu')) {
          closeModal('modal-menu-edit');
          loadAdminMenu();
        } else {
          loadHistory();
        }
      } else {
        alert("éŒ¯èª¤ï¼š" + res.message);
      }
    };
  }
</script>
</body>
</html>
